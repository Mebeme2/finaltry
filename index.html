<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Robot AR Model</title>
  <style>
    html, body {
      margin: 0; height: 100%; background: #000; color: #fff;
      font-family: system-ui, Arial, sans-serif;
      overflow: hidden;
    }
    #canvas-wrap { position: fixed; inset: 0; }
    #ui {
      position: fixed; left: 10px; bottom: 10px;
      display: flex; gap: 8px; z-index: 10;
    }
    button {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 12px;
      border-radius: 999px;
      color: #fff; font-size: 14px;
      cursor: pointer;
    }
    #hint {
      position: fixed; top: 10px; left: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 12px; border-radius: 8px;
      font-size: 13px; max-width: 280px;
    }
  </style>
</head>
<body>
  <div id="canvas-wrap"></div>
  <div id="ui">
    <button id="resetBtn">Reset View</button>
    <button id="toggleSpinBtn">Toggle Spin</button>
  </div>
  <div id="hint">üì± On Android Chrome: tap ‚ÄúEnter AR‚Äù ‚Üí move phone to scan ‚Üí tap to place robot.</div>

  <!-- Three.js + AR scripts -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

    let scene, camera, renderer, robot;
    let eyeMaterials = [], eyeLights = [];
    let animationRunning = true;

    let cameraTheta = 0, cameraPhi = Math.PI/3, cameraRadius = 8;
    const cameraTarget = new THREE.Vector3(0, 2, 0);

    let reticle, placed = false;

    const container = document.getElementById("canvas-wrap");

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.01, 100);
      camera.position.set(0, 4, cameraRadius);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      container.appendChild(renderer.domElement);

      setupLights();
      createGround();
      createRobot();

      // AR Button
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Reticle
      reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({ color: 0x00ffff })
      );
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // Place robot in AR
      renderer.domElement.addEventListener("click", () => {
        if (renderer.xr.isPresenting && reticle.visible && !placed) {
          robot.position.setFromMatrixPosition(reticle.matrix);
          placed = true;
        }
      });

      // UI Buttons
      document.getElementById("resetBtn").addEventListener("click", () => {
        cameraTheta = 0; cameraPhi = Math.PI/3; cameraRadius = 8;
        updateCamera();
      });
      document.getElementById("toggleSpinBtn").addEventListener("click", () => {
        animationRunning = !animationRunning;
      });

      window.addEventListener("resize", onWindowResize);
      updateCamera();
    }

    function setupLights() {
      const key = new THREE.DirectionalLight(0xffffff, 1);
      key.position.set(10, 15, 5); scene.add(key);
      scene.add(new THREE.AmbientLight(0x404040, 0.3));
    }

    function createGround() {
      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(50, 50),
        new THREE.MeshPhysicalMaterial({ color: 0x0a0a0a, roughness: 0.8 })
      );
      ground.rotation.x = -Math.PI/2;
      ground.position.y = -0.2;
      scene.add(ground);
    }

    function createRobot() {
      robot = new THREE.Group();
      const bodyMat = new THREE.MeshPhysicalMaterial({ color: 0xf8f8f8, roughness: 0.15 });
      const plastic = new THREE.MeshPhysicalMaterial({ color: 0x2c2c2c, roughness: 0.3 });
      const rubber = new THREE.MeshPhysicalMaterial({ color: 0x111111, roughness: 0.9 });
      const metal = new THREE.MeshPhysicalMaterial({ color: 0x666666, roughness: 0.2, metalness: 0.8 });

      // Body
      const body = new THREE.Mesh(new THREE.BoxGeometry(2.5, 3.5, 2), bodyMat);
      body.position.set(0, 2, 0);
      robot.add(body);

      // Head
      const head = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.0, 0.15), plastic);
      head.position.set(0, 3.0, 1.0);
      robot.add(head);

      // Eyes
      const eyeGeometry = new THREE.BoxGeometry(0.28, 0.28, 0.05);
      const eyeMat = new THREE.MeshPhysicalMaterial({
        color: 0x00ffff, emissive: 0x00aaaa, emissiveIntensity: 1.5,
        transparent: true, opacity: 0.95
      });

      const leftEye = new THREE.Mesh(eyeGeometry, eyeMat.clone());
      leftEye.position.set(-0.35, 3.0, 1.08);
      robot.add(leftEye); eyeMaterials.push(leftEye.material);

      const rightEye = new THREE.Mesh(eyeGeometry, eyeMat.clone());
      rightEye.position.set(0.35, 3.0, 1.08);
      robot.add(rightEye); eyeMaterials.push(rightEye.material);

      // Wheels
      const wheelGeom = new THREE.CylinderGeometry(0.45, 0.45, 0.25, 32);
      const positions = [[-1.2, 0.45, 0.7], [1.2, 0.45, 0.7], [-1.2, 0.45, -0.7], [1.2, 0.45, -0.7]];
      positions.forEach(p => {
        const wheel = new THREE.Mesh(wheelGeom, rubber);
        wheel.rotation.z = Math.PI/2;
        wheel.position.set(...p);
        robot.add(wheel);
      });

      robot.position.y = 1;
      scene.add(robot);
    }

    function updateCamera() {
      camera.position.x = cameraTarget.x + cameraRadius * Math.sin(cameraPhi) * Math.cos(cameraTheta);
      camera.position.y = cameraTarget.y + cameraRadius * Math.cos(cameraPhi);
      camera.position.z = cameraTarget.z + cameraRadius * Math.sin(cameraPhi) * Math.sin(cameraTheta);
      camera.lookAt(cameraTarget);
    }

    function animate() {
      renderer.setAnimationLoop(() => {
        if (animationRunning && robot) robot.rotation.y += 0.003;
        renderer.render(scene, camera);
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>
